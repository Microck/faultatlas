---
phase: 03-diagnosis-fixes
plan: "02"
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/models/fixes.py
  - src/core/diff_utils.py
  - src/core/fix_generator.py
  - tests/test_fix_generator.py
autonomous: true
must_haves:
  truths:
    - "Fix Generator proposes at least one fix for every taxonomy type (all 6)"
    - "Fix Generator produces an exact before/after unified diff for each proposed change"
  artifacts:
    - path: "src/core/fix_generator.py"
      provides: "Fix proposal generation"
    - path: "src/core/diff_utils.py"
      provides: "Unified diff generation for proposals"
    - path: "src/models/fixes.py"
      provides: "Fix proposal contract"
  key_links:
    - from: "src/core/fix_generator.py"
      to: "src/core/diff_utils.py"
      via: "unified diff"
      pattern: "unified_diff"

---

<objective>
Implement the Fix Generator that turns a diagnosis into concrete, reviewable fix proposals.

Purpose: Suggest actionable changes without auto-applying them (human approval required).
Output: Fix models + FixGenerator + diff utilities + unit tests.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-diagnosis-fixes/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define FixProposal models (PROMPT_FIX / TOOL_CONFIG_FIX / GUARDRAIL_FIX)</name>
  <files>
src/models/fixes.py
  </files>
  <action>
- Create `src/models/fixes.py` with:
  - `FixType` enum: PROMPT_FIX, TOOL_CONFIG_FIX, GUARDRAIL_FIX
  - `FixChange` model: `file`, `change_type`, `before`, `after`, `diff`.
  - `FixProposal` model: `fix_type`, `title`, `rationale`, `changes` (list[FixChange]).
- Keep the model designed for review (human can read `diff` and decide).
  </action>
  <verify>
python3 -c "from src.models.fixes import FixType; print([t.value for t in FixType])"
  </verify>
  <done>
- Fix proposal model exists and validates
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement diff utils + FixGenerator and cover with tests</name>
  <files>
src/core/diff_utils.py
src/core/fix_generator.py
tests/test_fix_generator.py
  </files>
  <action>
- Implement `src/core/diff_utils.py` using Python stdlib `difflib` to generate unified diffs.
- Implement `src/core/fix_generator.py` with `generate_fixes(diagnosis, findings_report) -> list[FixProposal]`.
- Required proposal behavior:
  - For TOOL_MISUSE (booking/search): propose a TOOL_CONFIG_FIX that adds a pre-validation/transformation step (e.g. date normalization) and show a diff against a *target file* (likely `src/subjects/*.py` for MVP).
  - For HALLUCINATION: propose a GUARDRAIL_FIX that adds a “must cite sources / refuse if no sources” rule.
  - For PROMPT_AMBIGUITY: propose a PROMPT_FIX adding explicit constraints and examples.
- Add required coverage for the remaining taxonomy types (must generate >=1 proposal each):
  - CONTEXT_OVERFLOW: propose a PROMPT_FIX that reduces/structures context (e.g., summarize + restate constraints; add a hard "context budget" section) and/or a TOOL_CONFIG_FIX that caps input length.
  - REASONING_ERROR: propose a PROMPT_FIX that adds a deterministic reasoning scaffold + self-check (e.g., "list assumptions", "verify against tool outputs").
  - COORDINATION_FAILURE: propose a GUARDRAIL_FIX and/or PROMPT_FIX that enforces a handoff protocol (state bundle + explicit ownership) and adds a validation step that required state is present before acting.
- Create `tests/test_fix_generator.py` that uses findings fixtures and asserts:
  - For each of the 6 FailureTaxonomy values, `generate_fixes(...)` returns at least one proposal.
  - Each change includes a non-empty `diff` string that starts with `---` / `+++`.
  - The set of returned proposals spans at least one of the FixType categories across the suite (PROMPT_FIX, TOOL_CONFIG_FIX, GUARDRAIL_FIX).
  </action>
  <verify>
python3 -m pytest -q
  </verify>
  <done>
- FixGenerator outputs reviewable diffs and tests pass
  </done>
</task>

</tasks>

<verification>
- `python3 -m pytest -q` passes
</verification>

<success_criteria>
- Phase 3 FIX-01..FIX-04 are satisfied: proposals exist and diffs are shown
</success_criteria>

<output>
After completion, create `.planning/phases/03-diagnosis-fixes/03-02-SUMMARY.md`
</output>
