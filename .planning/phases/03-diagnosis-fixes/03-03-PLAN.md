---
phase: 03-diagnosis-fixes
plan: "03"
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/storage/fix_history.py
  - src/storage/fix_history_memory.py
  - src/core/diagnosis_engine.py
  - tests/test_fix_history_memory.py
autonomous: true
user_setup:
  - service: azure-cosmos-db
    why: "Store past failures/fixes to enable DIAG-04 similarity linking"
    env_vars:
      - name: COSMOS_ENDPOINT
        source: "Azure Portal -> Cosmos DB account -> Keys -> URI"
      - name: COSMOS_KEY
        source: "Azure Portal -> Cosmos DB account -> Keys -> PRIMARY KEY"
      - name: COSMOS_DATABASE
        source: "Existing database used for traces"
      - name: COSMOS_CONTAINER_FIXES
        source: "Choose a container name (e.g. fixes)"
must_haves:
  truths:
    - "Diagnosis includes linkable similar past failure references (IDs), even if empty initially"
    - "Fix history can be stored and queried without Azure via in-memory backend"
  artifacts:
    - path: "src/storage/fix_history.py"
      provides: "Persist + query past failures/fixes"
    - path: "src/core/diagnosis_engine.py"
      provides: "Wired to similarity lookup"
  key_links:
    - from: "src/core/diagnosis_engine.py"
      to: "src/storage/fix_history.py"
      via: "query_similar"
      pattern: "similar_past_failure_ids|query_.*similar|find_.*similar"

---

<objective>
Add fix history storage + similarity lookup so diagnosis can reference prior cases (DIAG-04).

Purpose: Enable learning signals and a stronger demo (“this happened before”).
Output: FixHistory store (Cosmos + memory) and wiring into DiagnosisEngine.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-diagnosis-fixes/03-01-SUMMARY.md
@.planning/phases/03-diagnosis-fixes/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement FixHistory store (memory + Cosmos) with a simple similarity query</name>
  <files>
src/storage/fix_history.py
src/storage/fix_history_memory.py
tests/test_fix_history_memory.py
  </files>
  <action>
- Implement `src/storage/fix_history_memory.py` for tests/local dev:
  - `record_failure(failure_event, diagnosis)`
  - `record_fix(failure_id, fix_proposals)`
- Implement similarity lookup to satisfy DIAG-04 linkability:
  - `find_similar(diagnosis, findings_report, *, limit=5) -> list[str]` returning `failure_id` values (simple match on taxonomy + sub_type).
- Implement `src/storage/fix_history.py` Cosmos-backed version using a dedicated container.
- Add `tests/test_fix_history_memory.py` that records multiple failures and asserts:
  - `find_similar(...)` returns the expected `failure_id` values (order doesn't matter)
  - `len(find_similar(...))` matches the expected count
  </action>
  <verify>
python3 -m pytest -q
  </verify>
  <done>
- FixHistory exists with a working in-memory version and test coverage
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire DiagnosisEngine to populate similar_past_failures</name>
  <files>
src/core/diagnosis_engine.py
  </files>
  <action>
- Update `src/core/diagnosis_engine.py` to accept an optional FixHistory dependency (default to memory/no-op).
- After computing root_cause, call `find_similar(...)` and populate:
  - `similar_past_failure_ids` (list of failure_id strings)
  - `similar_past_failures` (derived count)
- Ensure behavior is stable when no FixHistory is configured: ids=[] and count=0.
  </action>
  <verify>
python3 -m pytest -q
  </verify>
  <done>
- Diagnosis output always includes `similar_past_failure_ids` and `similar_past_failures`
- `similar_past_failures == len(similar_past_failure_ids)` and tests still pass
  </done>
</task>

</tasks>

<verification>
- `python3 -m pytest -q` passes
</verification>

<success_criteria>
- DIAG-04 is satisfied: diagnoses link to similar past failures (IDs + derived count), even when initial corpus is empty
</success_criteria>

<output>
After completion, create `.planning/phases/03-diagnosis-fixes/03-03-SUMMARY.md`
</output>
