---
phase: 02-analysis-pipeline
plan: "03"
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - src/core/indagine_controller.py
  - src/core/indagine_pipeline.py
  - tests/test_indagine_controller.py
autonomous: true
must_haves:
  truths:
    - "Indagine Controller runs TraceAnalyzer + ToolAnalyzer and returns a unified FindingsReport"
    - "Indagine Controller is a stable entrypoint for Phase 3 diagnosis"
    - "IndaginePipeline loads traces via TraceStore using an injected backend (memory or cosmos)"
  artifacts:
    - path: "src/core/indagine_controller.py"
      provides: "Orchestrates analyzers; produces unified report"
    - path: "tests/test_indagine_controller.py"
      provides: "Integration-level proof for orchestration"
  key_links:
    - from: "src/core/indagine_controller.py"
      to: "src/analyzers/trace_analyzer.py"
      via: "TraceAnalyzer.analyze"
      pattern: "TraceAnalyzer"
    - from: "src/core/indagine_controller.py"
      to: "src/analyzers/tool_analyzer.py"
      via: "ToolAnalyzer.analyze"
      pattern: "ToolAnalyzer"
    - from: "src/core/indagine_pipeline.py"
      to: "src/storage/trace_store.py"
      via: "injected TraceStore (memory|cosmos)"
      pattern: "get_trace\(|TraceStore"

---

<objective>
Implement the Indagine Controller that orchestrates analyzers and emits a unified FindingsReport.

Purpose: Provide a single call that converts a stored trace into structured findings.
Output: IndagineController + pipeline wiring + tests.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-analysis-pipeline/02-01-SUMMARY.md
@.planning/phases/02-analysis-pipeline/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build IndagineController orchestration API</name>
  <files>
src/core/indagine_controller.py
src/core/indagine_pipeline.py
  </files>
  <action>
- Implement `src/core/indagine_controller.py` with `run_indagine(trace_record) -> FindingsReport`.
- Orchestration behavior:
  - Run TraceAnalyzer and ToolAnalyzer (sequential is fine for MVP; keep a simple option to run in parallel later).
  - Collect outputs into a single `FindingsReport` keyed by analyzer name.
- Implement `src/core/indagine_pipeline.py` as a thin glue module that:
  - Accepts a `TraceStore` dependency (do not instantiate Cosmos client inside this module).
  - Loads trace by `failure_id` via the injected TraceStore (`get_trace`).
  - Calls IndagineController.
  - Returns FindingsReport.
  - Include a small helper/factory for selecting a backend (memory|cosmos) by reusing the existing TraceStore creation logic from Phase 1 (do not duplicate env parsing).
Keep these modules free of Azure dependencies (they operate on plain JSON).
  </action>
  <verify>
python3 -c "import json; from src.core.indagine_controller import run_indagine; from pathlib import Path; tr=json.loads(Path('tests/fixtures/traces/booking.json').read_text()); r=run_indagine(tr); print(sorted(r.findings.keys()))"
  </verify>
  <done>
- IndagineController returns unified report for fixture traces
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration test for unified FindingsReport shape</name>
  <files>
tests/test_indagine_controller.py
  </files>
  <action>
- Add `tests/test_indagine_controller.py` that loads a fixture trace and asserts:
  - FindingsReport includes entries for both analyzers
  - Trace finding includes `failure_step` and `reasoning_chain`
  - Tool finding includes at least one issue for the SearchAgent fixture
  </action>
  <verify>
python3 -m pytest -q
  </verify>
  <done>
- Test passes and locks the unified output contract
  </done>
</task>

</tasks>

<verification>
- `python3 -m pytest -q` passes
</verification>

<success_criteria>
- Phase 2 success criteria are met: analyzers exist and controller produces unified structured output
</success_criteria>

<output>
After completion, create `.planning/phases/02-analysis-pipeline/02-03-SUMMARY.md`
</output>
